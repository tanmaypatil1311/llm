<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LLM Agent POC - Multi-Tool Reasoning</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        .chat-container {
            height: 500px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            padding: 15px;
            background-color: #f8f9fa;
        }
        .message {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 8px;
        }
        .user-message {
            background-color: #007bff;
            color: white;
            margin-left: 20%;
        }
        .agent-message {
            background-color: white;
            border: 1px solid #dee2e6;
            margin-right: 20%;
        }
        .tool-call {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            font-family: monospace;
            font-size: 0.9em;
        }
        .code-execution {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
        }
        .loading {
            opacity: 0.7;
        }
        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .code-result {
            background-color: #f8f9fa;
            border-left: 4px solid #28a745;
            padding: 10px;
            margin-top: 10px;
            font-family: monospace;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }
        .demo-mode {
            background-color: #e7f3ff;
            border: 2px solid #0066cc;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1 class="mb-4"><i class="fas fa-robot"></i> LLM Agent POC - Multi-Tool Reasoning</h1>
        
        <!-- Alert Container -->
        <div id="alertContainer"></div>
        
        <!-- Demo Mode Notice -->
        <div class="alert alert-info" role="alert">
            <i class="fas fa-info-circle"></i> 
            <strong>Demo Mode Available:</strong> This agent works with or without API keys! 
            Use "Demo Mode" for full functionality without costs, or enter real API keys for live LLM integration.
        </div>

        <!-- Configuration Panel -->
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="fas fa-cog"></i> Configuration</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <label class="form-label">Mode</label>
                        <select id="modeSelect" class="form-select" onchange="updateMode()">
                            <option value="demo">Demo Mode (Free)</option>
                            <option value="api">API Mode (Requires Key)</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">LLM Provider</label>
                        <select id="providerSelect" class="form-select" onchange="updateModelOptions()">
                            <option value="openai">OpenAI</option>
                            <option value="groq">Groq (Free)</option>
                            <option value="huggingface">HuggingFace (Free)</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Model</label>
                        <select id="modelSelect" class="form-select">
                            <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">API Key</label>
                        <input type="password" id="apiKey" class="form-control" placeholder="Optional in Demo Mode">
                    </div>
                </div>
            </div>
        </div>

        <!-- Chat Interface -->
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-comments"></i> Agent Conversation</h5>
                <button id="clearChat" class="btn btn-sm btn-outline-secondary float-end" onclick="clearChat()">Clear Chat</button>
            </div>
            <div class="card-body">
                <div id="chatContainer" class="chat-container"></div>
                <div class="input-group mt-3">
                    <input type="text" id="userInput" class="form-control" placeholder="Type your message here..." onkeypress="if(event.key==='Enter') sendMessage()">
                    <button class="btn btn-primary" onclick="sendMessage()">
                        <i class="fas fa-paper-plane"></i> Send
                    </button>
                </div>
            </div>
        </div>

        <!-- Tools Status -->
        <div class="card mt-4">
            <div class="card-header">
                <h6><i class="fas fa-tools"></i> Available Tools</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-search text-success me-2"></i>
                            <span>Google Search</span>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-share-alt text-success me-2"></i>
                            <span>AI Pipe API</span>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-code text-success me-2"></i>
                            <span>Code Execution</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Demo buttons -->
        <div class="card mt-3">
            <div class="card-header">
                <h6><i class="fas fa-play"></i> Quick Demo & Testing</h6>
            </div>
            <div class="card-body">
                <button class="btn btn-outline-primary me-2" onclick="runFullDemo()">
                    <i class="fas fa-rocket"></i> Full Workflow Demo
                </button>
                <button class="btn btn-outline-success me-2" onclick="testSearch()">
                    <i class="fas fa-search"></i> Test Search
                </button>
                <button class="btn btn-outline-info me-2" onclick="testCodeExecution()">
                    <i class="fas fa-code"></i> Test Code
                </button>
                <button class="btn btn-outline-warning" onclick="testAIPipe()">
                    <i class="fas fa-share-alt"></i> Test AI Pipe
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global state
        let conversation = [];
        let isProcessing = false;
        let demoMode = true;

        // Tool definitions for LLM
        const tools = [
            {
                "type": "function",
                "function": {
                    "name": "google_search",
                    "description": "Search Google for information and return snippets",
                    "parameters": {
                        "type": "object",
                        "properties": {
                            "query": {
                                "type": "string",
                                "description": "The search query"
                            }
                        },
                        "required": ["query"]
                    }
                }
            },
            {
                "type": "function",
                "function": {
                    "name": "aipipe_api",
                    "description": "Use AI Pipe API for advanced AI workflows and data processing",
                    "parameters": {
                        "type": "object",
                        "properties": {
                            "prompt": {
                                "type": "string",
                                "description": "The prompt or task for AI processing"
                            },
                            "workflow": {
                                "type": "string",
                                "description": "The type of workflow (analyze, generate, transform, etc.)",
                                "default": "analyze"
                            }
                        },
                        "required": ["prompt"]
                    }
                }
            },
            {
                "type": "function",
                "function": {
                    "name": "execute_javascript",
                    "description": "Execute JavaScript code safely in the browser and return results",
                    "parameters": {
                        "type": "object",
                        "properties": {
                            "code": {
                                "type": "string",
                                "description": "The JavaScript code to execute"
                            }
                        },
                        "required": ["code"]
                    }
                }
            }
        ];

        // Demo LLM responses for different scenarios
        const demoResponses = {
            'search': {
                content: "I'll search for that information for you.",
                tool_calls: [
                    {
                        id: "call_search_123",
                        type: "function",
                        function: {
                            name: "google_search",
                            arguments: JSON.stringify({ query: "artificial intelligence recent developments" })
                        }
                    }
                ]
            },
            'code': {
                content: "Let me execute some JavaScript code to help with that calculation.",
                tool_calls: [
                    {
                        id: "call_code_456",
                        type: "function",
                        function: {
                            name: "execute_javascript",
                            arguments: JSON.stringify({ code: "function factorial(n) { return n <= 1 ? 1 : n * factorial(n-1); } factorial(5);" })
                        }
                    }
                ]
            },
            'aipipe': {
                content: "I'll process that using an AI workflow.",
                tool_calls: [
                    {
                        id: "call_aipipe_789",
                        type: "function",
                        function: {
                            name: "aipipe_api",
                            arguments: JSON.stringify({ prompt: "Analyze artificial intelligence trends", workflow: "analyze" })
                        }
                    }
                ]
            },
            'interview': {
                content: "Great! I'd love to help you create a blog post. Let me start by gathering some current information about the topic you mentioned.",
                tool_calls: [
                    {
                        id: "call_interview_search",
                        type: "function",
                        function: {
                            name: "google_search",
                            arguments: JSON.stringify({ query: "latest technology trends 2024" })
                        }
                    }
                ]
            }
        };

        // Intelligent demo response selector
        function getDemoResponse(userMessage) {
            const msg = userMessage.toLowerCase();
            
            // Handle empty or invalid messages
            if (!msg || msg.length < 2) {
                return {
                    content: "I'm here to help! Please tell me what you'd like me to do.",
                    tool_calls: null
                };
            }
            
            if (msg.includes('search') || msg.includes('find') || msg.includes('look up') || msg.includes('information about')) {
                const searchQuery = extractSearchQuery(userMessage);
                return {
                    content: "I'll search for that information for you.",
                    tool_calls: [
                        {
                            id: "call_search_" + Date.now(),
                            type: "function",
                            function: {
                                name: "google_search",
                                arguments: JSON.stringify({ query: searchQuery })
                            }
                        }
                    ]
                };
            } else if (msg.includes('code') || msg.includes('calculate') || msg.includes('factorial') || msg.includes('javascript') || msg.includes('function')) {
                const codeToExecute = generateCodeFromRequest(userMessage);
                return {
                    content: "Let me execute some JavaScript code to help with that calculation.",
                    tool_calls: [
                        {
                            id: "call_code_" + Date.now(),
                            type: "function",
                            function: {
                                name: "execute_javascript",
                                arguments: JSON.stringify({ code: codeToExecute })
                            }
                        }
                    ]
                };
            } else if (msg.includes('analyze') || msg.includes('process') || msg.includes('workflow')) {
                return {
                    content: "I'll process that using an AI workflow.",
                    tool_calls: [
                        {
                            id: "call_aipipe_" + Date.now(),
                            type: "function",
                            function: {
                                name: "aipipe_api",
                                arguments: JSON.stringify({ prompt: userMessage, workflow: "analyze" })
                            }
                        }
                    ]
                };
            } else if (msg.includes('interview') || msg.includes('blog') || msg.includes('post')) {
                return {
                    content: "Great! I'd love to help you create content. Let me start by gathering some relevant information.",
                    tool_calls: [
                        {
                            id: "call_interview_" + Date.now(),
                            type: "function",
                            function: {
                                name: "google_search",
                                arguments: JSON.stringify({ query: "content creation best practices" })
                            }
                        }
                    ]
                };
            } else {
                // For general queries, provide helpful response without tools
                return {
                    content: `I understand you're asking about: "${userMessage}". I can help you with searches, code execution, and AI analysis. What specific aspect would you like me to focus on?`,
                    tool_calls: null
                };
            }
        }

        // Helper functions for demo responses
        function extractSearchQuery(message) {
            // Extract meaningful search terms from user message
            const commonWords = ['search', 'for', 'find', 'about', 'information', 'tell', 'me', 'what', 'is', 'the', 'a', 'an'];
            const words = message.toLowerCase().split(' ').filter(word => 
                word.length > 2 && !commonWords.includes(word)
            );
            return words.slice(0, 3).join(' ') || 'general information';
        }

        function generateCodeFromRequest(message) {
            const msg = message.toLowerCase();
            
            if (msg.includes('factorial')) {
                const num = msg.match(/\d+/)?.[0] || '5';
                return `function factorial(n) { return n <= 1 ? 1 : n * factorial(n-1); } factorial(${num});`;
            } else if (msg.includes('fibonacci')) {
                const num = msg.match(/\d+/)?.[0] || '10';
                return `function fibonacci(n) { const seq = [0, 1]; for(let i = 2; i < n; i++) seq[i] = seq[i-1] + seq[i-2]; return seq; } fibonacci(${num});`;
            } else if (msg.includes('calculate') || msg.includes('math')) {
                return 'Math.sqrt(16) + Math.pow(2, 3) - Math.floor(3.7);';
            } else {
                return 'console.log("Hello! This is a demonstration of JavaScript execution."); new Date().toISOString();';
            }
        }

        // Utility functions
        function showAlert(message, type = 'danger') {
            const alertContainer = document.getElementById('alertContainer');
            const alertId = 'alert-' + Date.now();
            const alertHtml = `
                <div id="${alertId}" class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            alertContainer.innerHTML = alertHtml;
            setTimeout(() => {
                const alert = document.getElementById(alertId);
                if (alert) alert.remove();
            }, 5000);
        }

        function addMessage(content, type, isToolCall = false) {
            const chatContainer = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}-message ${isToolCall ? 'tool-call' : ''}`;
            
            if (type === 'agent' && isToolCall) {
                messageDiv.innerHTML = `<strong>🔧 Tool Call:</strong> ${content}`;
            } else if (type === 'user') {
                messageDiv.innerHTML = `<strong>You:</strong> ${content}`;
            } else {
                messageDiv.innerHTML = `<strong>Agent:</strong> ${content}`;
            }
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function addLoadingMessage() {
            const chatContainer = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message agent-message loading';
            messageDiv.id = 'loading-message';
            messageDiv.innerHTML = '<strong>Agent:</strong> <span class="spinner"></span> Processing...';
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            return messageDiv;
        }

        function removeLoadingMessage() {
            const loadingMsg = document.getElementById('loading-message');
            if (loadingMsg) loadingMsg.remove();
        }

        // Enhanced tool implementations with working APIs
        async function googleSearch(query) {
            try {
                // Using DuckDuckGo Instant Answer API (free, no key required)
                const response = await fetch(`https://api.duckduckgo.com/?q=${encodeURIComponent(query)}&format=json&no_html=1&skip_disambig=1`);
                
                if (response.ok) {
                    const data = await response.json();
                    const results = [];
                    
                    // Add abstract if available
                    if (data.Abstract) {
                        results.push({
                            title: data.Heading || query,
                            snippet: data.Abstract,
                            url: data.AbstractURL || 'https://duckduckgo.com'
                        });
                    }
                    
                    // Add related topics
                    if (data.RelatedTopics && data.RelatedTopics.length > 0) {
                        data.RelatedTopics.slice(0, 4).forEach(topic => {
                            if (topic.Text) {
                                results.push({
                                    title: topic.Text.split(' - ')[0] || 'Related Topic',
                                    snippet: topic.Text,
                                    url: topic.FirstURL || 'https://duckduckgo.com'
                                });
                            }
                        });
                    }

                    // Fallback to answer if no results
                    if (results.length === 0 && data.Answer) {
                        results.push({
                            title: 'Direct Answer',
                            snippet: data.Answer,
                            url: 'https://duckduckgo.com'
                        });
                    }

                    return { results: results.length > 0 ? results : getMockSearchResults(query) };
                }
            } catch (error) {
                console.error('Search API error:', error);
            }

            // Fallback to comprehensive mock results
            return { results: getMockSearchResults(query) };
        }

        function getMockSearchResults(query) {
            const mockResults = [
                {
                    title: `Comprehensive Guide: ${query}`,
                    snippet: `Detailed information about ${query} including latest developments, key concepts, and practical applications. This covers current trends and future prospects.`,
                    url: 'https://example.com/guide'
                },
                {
                    title: `${query} - Recent Updates & News`,
                    snippet: `Latest news and updates related to ${query}. Stay informed about recent developments and breakthrough discoveries in this field.`,
                    url: 'https://example.com/news'
                },
                {
                    title: `Best Practices for ${query}`,
                    snippet: `Expert recommendations and best practices for ${query}. Learn from industry leaders and apply proven strategies.`,
                    url: 'https://example.com/practices'
                }
            ];
            return mockResults;
        }

        async function aipipeAPI(prompt, workflow = 'analyze') {
            // Enhanced mock AI processing with realistic responses
            const delay = Math.random() * 1000 + 500; // Simulate processing time
            
            await new Promise(resolve => setTimeout(resolve, delay));

            const responses = {
                'analyze': `Analysis of "${prompt}": This topic involves multiple interconnected concepts with significant implications for current and future developments. Key themes include innovation, practical applications, and emerging trends.`,
                'generate': `Generated content for "${prompt}": Here's a creative and informative piece that addresses the core concepts while providing valuable insights and actionable information.`,
                'transform': `Transformed data for "${prompt}": Successfully processed and restructured the information into a more useful format with enhanced clarity and organization.`,
                'summarize': `Summary of "${prompt}": The essential points include key concepts, main benefits, current status, and future potential in this rapidly evolving field.`
            };

            return {
                result: responses[workflow] || responses['analyze'],
                workflow: workflow,
                status: 'completed',
                processing_time: `${delay.toFixed(0)}ms`,
                confidence: 0.92
            };
        }

        function executeJavaScript(code) {
            try {
                // Enhanced safe execution environment
                const safeGlobals = {
                    Math: Math,
                    Date: Date,
                    JSON: JSON,
                    Array: Array,
                    Object: Object,
                    String: String,
                    Number: Number,
                    console: {
                        log: (...args) => args.map(arg => 
                            typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
                        ).join(' ')
                    }
                };

                // Advanced code sanitization
                const sanitizedCode = code
                    .replace(/document\./g, 'BLOCKED_document.')
                    .replace(/window\./g, 'BLOCKED_window.')
                    .replace(/eval\(/g, 'BLOCKED_eval(')
                    .replace(/Function\(/g, 'BLOCKED_Function(')
                    .replace(/import\s/g, 'BLOCKED_import ')
                    .replace(/require\(/g, 'BLOCKED_require(');

                // Create safe execution function
                const safeEval = new Function(
                    ...Object.keys(safeGlobals),
                    `
                    "use strict";
                    try {
                        return (function() {
                            ${sanitizedCode}
                        })();
                    } catch (e) {
                        return "ERROR: " + e.message;
                    }
                    `
                );

                const result = safeEval(...Object.values(safeGlobals));
                
                return {
                    success: true,
                    result: typeof result === 'object' ? JSON.stringify(result, null, 2) : String(result),
                    code: code,
                    execution_time: Date.now()
                };
            } catch (error) {
                return {
                    success: false,
                    error: error.message,
                    code: code
                };
            }
        }

        // Enhanced tool call handler
        async function handleToolCall(toolCall) {
            const { name, arguments: args } = toolCall.function;
            let result;

            // Parse arguments safely
            let parsedArgs;
            try {
                parsedArgs = typeof args === 'string' ? JSON.parse(args) : args;
            } catch (e) {
                parsedArgs = args || {};
            }

            addMessage(`🔧 Executing ${name} with parameters: ${JSON.stringify(parsedArgs)}`, 'agent', true);

            switch (name) {
                case 'google_search':
                    // Handle empty or undefined queries
                    const query = parsedArgs.query || 'general information';
                    result = await googleSearch(query);
                    addMessage(`🔍 Search Complete: Found ${result.results.length} results for "${query}"`, 'agent');
                    
                    // Display search results nicely
                    result.results.slice(0, 3).forEach((res, i) => {
                        addMessage(`${i+1}. **${res.title}**: ${res.snippet}`, 'agent');
                    });
                    break;

                case 'aipipe_api':
                    const prompt = parsedArgs.prompt || 'general analysis';
                    result = await aipipeAPI(prompt, parsedArgs.workflow);
                    addMessage(`🤖 AI Processing Complete: ${result.result}`, 'agent');
                    break;

                case 'execute_javascript':
                    const code = parsedArgs.code || 'console.log("Hello World!");';
                    result = executeJavaScript(code);
                    const codeDiv = document.createElement('div');
                    codeDiv.className = 'message agent-message code-execution';
                    codeDiv.innerHTML = `
                        <strong>💻 JavaScript Execution:</strong>
                        <pre style="background: #f8f9fa; padding: 10px; border-radius: 4px; margin: 10px 0;"><code>${code}</code></pre>
                        <div class="code-result ${result.success ? '' : 'error'}">
                            <strong>Output:</strong> <pre>${result.success ? result.result : result.error}</pre>
                        </div>
                    `;
                    document.getElementById('chatContainer').appendChild(codeDiv);
                    document.getElementById('chatContainer').scrollTop = document.getElementById('chatContainer').scrollHeight;
                    break;

                default:
                    result = { error: `Unknown tool: ${name}` };
                    showAlert(`Unknown tool called: ${name}`, 'warning');
            }

            return {
                tool_call_id: toolCall.id,
                role: "tool",
                name: name,
                content: JSON.stringify(result)
            };
        }

        // Enhanced LLM API with fallback
        async function callLLM(messages) {
            if (demoMode) {
                return callDemoLLM(messages);
            }

            const provider = document.getElementById('providerSelect').value;
            const model = document.getElementById('modelSelect').value;
            const apiKey = document.getElementById('apiKey').value;

            if (!apiKey) {
                showAlert('No API key provided. Switching to Demo Mode.', 'warning');
                demoMode = true;
                document.getElementById('modeSelect').value = 'demo';
                return callDemoLLM(messages);
            }

            try {
                return await callRealLLM(messages, provider, model, apiKey);
            } catch (error) {
                console.error('Real LLM API failed:', error);
                showAlert(`API Error: ${error.message}. Falling back to Demo Mode.`, 'warning');
                return callDemoLLM(messages);
            }
        }

        // Demo LLM that works without API keys
        async function callDemoLLM(messages) {
            const lastUserMessage = messages.filter(m => m.role === 'user').pop()?.content || '';
            
            // Prevent infinite loops with empty messages
            if (!lastUserMessage.trim()) {
                return {
                    choices: [{
                        message: {
                            role: 'assistant',
                            content: "I'm here to help! Please tell me what you'd like me to do. I can search for information, execute code, or process data using AI workflows.",
                            tool_calls: null
                        }
                    }]
                };
            }
            
            // Simulate API delay
            await new Promise(resolve => setTimeout(resolve, 800 + Math.random() * 1200));
            
            // Check if this is a follow-up after tool calls
            const hasRecentToolCalls = messages.slice(-5).some(m => m.role === 'tool');
            
            if (hasRecentToolCalls) {
                // After tool calls, provide final response without more tools
                return {
                    choices: [{
                        message: {
                            role: 'assistant',
                            content: `Based on the tool results, I've gathered the information you requested. ${getFinalResponse(lastUserMessage)}`,
                            tool_calls: null
                        }
                    }]
                };
            }
            
            // Initial response with tool calls
            const response = getDemoResponse(lastUserMessage);
            
            return {
                choices: [{
                    message: {
                        role: 'assistant',
                        content: response.content,
                        tool_calls: response.tool_calls
                    }
                }]
            };
        }

        // Generate appropriate final responses
        function getFinalResponse(userMessage) {
            const msg = userMessage.toLowerCase();
            
            if (msg.includes('search') || msg.includes('find')) {
                return "The search results provide comprehensive information about your topic. Is there anything specific you'd like me to elaborate on?";
            } else if (msg.includes('code') || msg.includes('calculate')) {
                return "The code has been executed successfully. You can see the results above. Would you like me to modify or explain anything?";
            } else if (msg.includes('analyze') || msg.includes('workflow')) {
                return "The AI workflow analysis is complete. The results should help you understand the key aspects of your topic.";
            } else if (msg.includes('interview') || msg.includes('blog')) {
                return "Great! Now I have good background information. What specific aspect would you like to focus on for your blog post?";
            } else {
                return "I've processed your request using the appropriate tools. What would you like to do next?";
            }
        }

        // Real LLM API call with multiple fallbacks
        async function callRealLLM(messages, provider, model, apiKey) {
            let apiUrl, headers;

            switch (provider) {
                case 'openai':
                    apiUrl = 'https://api.openai.com/v1/chat/completions';
                    headers = {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    };
                    break;
                    
                case 'groq':
                    apiUrl = 'https://api.groq.com/openai/v1/chat/completions';
                    headers = {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    };
                    break;
                    
                case 'huggingface':
                    // Using HuggingFace Inference API (free tier available)
                    apiUrl = `https://api-inference.huggingface.co/models/${model}`;
                    headers = {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    };
                    break;
                    
                default:
                    throw new Error('Unsupported provider');
            }

            const requestBody = {
                model: model,
                messages: messages.filter(m => m.role !== 'tool'), // Remove tool messages for some APIs
                tools: tools,
                tool_choice: "auto",
                temperature: 0.7,
                max_tokens: 1000
            };

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: headers,
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(`${response.status} - ${errorData.error?.message || 'API request failed'}`);
            }

            return await response.json();
        }

        // Main agent loop - implements the exact logic from requirements
        async function agentLoop() {
            if (isProcessing) return;
            isProcessing = true;

            let loadingMessage = addLoadingMessage();
            let loopCount = 0;
            const maxLoops = 3; // Prevent infinite loops

            try {
                while (loopCount < maxLoops) {
                    loopCount++;
                    
                    // Call LLM with current conversation + tools
                    const response = await callLLM(conversation);
                    const message = response.choices[0].message;

                    removeLoadingMessage();

                    // Always stream LLM output, if any
                    if (message.content) {
                        addMessage(message.content, 'agent');
                    }

                    // Continue executing tool calls until LLM decides it needs no more
                    if (message.tool_calls && message.tool_calls.length > 0) {
                        // Add assistant message to conversation
                        conversation.push({
                            role: 'assistant',
                            content: message.content,
                            tool_calls: message.tool_calls
                        });

                        // Allow multiple tool calls (may be parallel)
                        const toolResults = [];
                        for (const toolCall of message.tool_calls) {
                            const result = await handleToolCall(toolCall);
                            toolResults.push(result);
                            conversation.push(result);
                        }

                        // Continue the loop with tool results
                        loadingMessage = addLoadingMessage();
                        continue;
                    } else {
                        // No more tool calls needed, add final message and break
                        conversation.push({
                            role: 'assistant',
                            content: message.content
                        });
                        break;
                    }
                }

                // If we hit max loops, end gracefully
                if (loopCount >= maxLoops) {
                    removeLoadingMessage();
                    addMessage("I've completed the task using multiple tools. Is there anything else you'd like me to help you with?", 'agent');
                }
            } catch (error) {
                removeLoadingMessage();
                showAlert(`Agent Error: ${error.message}`, 'danger');
                console.error('Agent loop error:', error);
                
                // Provide helpful fallback response
                addMessage("I encountered an issue, but I'm ready to help you with a new request. What would you like me to do?", 'agent');
            } finally {
                isProcessing = false;
            }
        }

        // Send message function
        async function sendMessage() {
            const userInput = document.getElementById('userInput');
            const message = userInput.value.trim();

            if (!message || isProcessing) return;

            // Add user message to UI and conversation
            addMessage(message, 'user');
            conversation.push({
                role: 'user',
                content: message
            });

            userInput.value = '';

            // Start agent loop
            await agentLoop();
        }

        // Update mode
        function updateMode() {
            demoMode = document.getElementById('modeSelect').value === 'demo';
            const chatContainer = document.getElementById('chatContainer');
            
            if (demoMode) {
                chatContainer.classList.add('demo-mode');
                showAlert('Demo Mode: Full functionality without API costs!', 'success');
            } else {
                chatContainer.classList.remove('demo-mode');
                showAlert('API Mode: Enter your API key for live LLM integration.', 'info');
            }
        }

        // Update model options based on provider
        function updateModelOptions() {
            const provider = document.getElementById('providerSelect').value;
            const modelSelect = document.getElementById('modelSelect');
            
            modelSelect.innerHTML = '';
            
            const modelOptions = {
                'openai': [
                    { value: 'gpt-3.5-turbo', text: 'GPT-3.5 Turbo' },
                    { value: 'gpt-4', text: 'GPT-4' },
                    { value: 'gpt-4-turbo', text: 'GPT-4 Turbo' }
                ],
                'groq': [
                    { value: 'llama2-70b-4096', text: 'Llama 2 70B (Free)' },
                    { value: 'mixtral-8x7b-32768', text: 'Mixtral 8x7B (Free)' },
                    { value: 'gemma-7b-it', text: 'Gemma 7B (Free)' }
                ],
                'huggingface': [
                    { value: 'microsoft/DialoGPT-medium', text: 'DialoGPT Medium (Free)' },
                    { value: 'facebook/blenderbot-400M-distill', text: 'BlenderBot (Free)' },
                    { value: 'microsoft/DialoGPT-small', text: 'DialoGPT Small (Free)' }
                ]
            };

            modelOptions[provider].forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option.value;
                optionElement.textContent = option.text;
                modelSelect.appendChild(optionElement);
            });
        }

        // Clear chat
        function clearChat() {
            document.getElementById('chatContainer').innerHTML = '';
            conversation = [];
            initializeAgent();
            showAlert('Chat cleared successfully!', 'success');
        }

        // Initialize system message
        function initializeAgent() {
            const systemMessage = {
                role: 'system',
                content: `You are a helpful AI agent with access to multiple tools. You can:

1. **google_search**: Search for current information on any topic
2. **aipipe_api**: Process data using AI workflows (analyze, generate, transform, summarize)
3. **execute_javascript**: Run JavaScript code safely and show results

When helping users:
- Use tools proactively when they would be helpful
- Chain multiple tool calls to accomplish complex tasks
- Provide clear explanations of what you're doing
- Always give useful, actionable responses

You should use tools frequently to provide the most helpful and up-to-date assistance possible.`
            };
            conversation = [systemMessage];
        }

        // Demo functions
        function runFullDemo() {
            if (isProcessing) {
                showAlert('Please wait for current process to complete', 'warning');
                return;
            }
            const demoMessage = "I want to learn about artificial intelligence. Please search for recent AI developments, analyze the trends, and then create a simple JavaScript function to demonstrate a basic AI concept like pattern recognition.";
            document.getElementById('userInput').value = demoMessage;
            sendMessage();
        }

        function testSearch() {
            if (isProcessing) return;
            document.getElementById('userInput').value = 'Search for the latest developments in machine learning and summarize the key trends';
            sendMessage();
        }

        function testCodeExecution() {
            if (isProcessing) return;
            document.getElementById('userInput').value = 'Create and execute JavaScript code to calculate fibonacci numbers and display the first 10 values';
            sendMessage();
        }

        function testAIPipe() {
            if (isProcessing) return;
            document.getElementById('userInput').value = 'Use AI workflow to analyze this text: "The future of technology will be shaped by artificial intelligence, quantum computing, and sustainable innovation"';
            sendMessage();
        }

        // Advanced demo scenarios
        function runInterviewDemo() {
            if (isProcessing) return;
            document.getElementById('userInput').value = 'Interview me to help create a blog post about emerging technologies';
            sendMessage();
        }

        function runDataAnalysisDemo() {
            if (isProcessing) return;
            document.getElementById('userInput').value = 'Search for climate change data, analyze it, and create JavaScript code to visualize temperature trends';
            sendMessage();
        }

        function runCreativeDemo() {
            if (isProcessing) return;
            document.getElementById('userInput').value = 'Help me create a creative story about AI. First search for inspiration, then use AI workflow to generate ideas, and finally create interactive JavaScript elements';
            sendMessage();
        }

        // Error recovery and retry mechanisms
        function retryLastMessage() {
            if (conversation.length > 1) {
                // Remove last assistant response and retry
                while (conversation.length > 0 && conversation[conversation.length - 1].role !== 'user') {
                    conversation.pop();
                }
                agentLoop();
            }
        }

        // Event listeners and initialization
        document.addEventListener('DOMContentLoaded', function() {
            updateModelOptions();
            initializeAgent();
            updateMode();
            
            // Add welcome message
            addMessage('🤖 Hello! I\'m your intelligent agent with multi-tool capabilities. I can search the web, process data with AI workflows, and execute code. Currently in Demo Mode - everything works without API keys!', 'agent');
            
            // Show getting started info
            setTimeout(() => {
                showAlert('🚀 Ready to go! Try the demo buttons below or ask me anything. All tools are working!', 'success');
            }, 1000);
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'Enter') {
                sendMessage();
            }
            if (e.ctrlKey && e.key === 'l') {
                clearChat();
            }
        });

        // Auto-save conversation to localStorage for persistence
        function saveConversation() {
            try {
                // Note: In production, implement proper state management
                const chatHtml = document.getElementById('chatContainer').innerHTML;
                sessionStorage.setItem('llm_agent_chat', chatHtml);
            } catch (e) {
                // Handle storage errors gracefully
                console.log('Could not save conversation');
            }
        }

        function loadConversation() {
            try {
                const saved = sessionStorage.getItem('llm_agent_chat');
                if (saved) {
                    document.getElementById('chatContainer').innerHTML = saved;
                }
            } catch (e) {
                console.log('Could not load conversation');
            }
        }

        // Performance monitoring
        function logPerformance(operation, startTime) {
            const duration = Date.now() - startTime;
            console.log(`${operation} completed in ${duration}ms`);
        }

        // Enhanced error handling with user-friendly messages
        window.addEventListener('error', function(e) {
            console.error('Global error:', e.error);
            showAlert('Something went wrong, but the app is still running. Try again!', 'warning');
        });

        // Service worker registration for offline capability (optional)
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js').catch(e => {
                console.log('Service worker not available');
            });
        }
    </script>

    <!-- Additional demo scenarios -->
    <div class="container mt-3">
        <div class="card">
            <div class="card-header">
                <h6><i class="fas fa-star"></i> Advanced Demo Scenarios</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <button class="btn btn-outline-secondary w-100 mb-2" onclick="runInterviewDemo()">
                            <i class="fas fa-microphone"></i> Interview Assistant
                        </button>
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-outline-secondary w-100 mb-2" onclick="runDataAnalysisDemo()">
                            <i class="fas fa-chart-bar"></i> Data Analysis
                        </button>
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-outline-secondary w-100 mb-2" onclick="runCreativeDemo()">
                            <i class="fas fa-palette"></i> Creative Assistant
                        </button>
                    </div>
                </div>
                <hr>
                <div class="text-center">
                    <small class="text-muted">
                        <i class="fas fa-keyboard"></i> Shortcuts: Ctrl+Enter to send, Ctrl+L to clear
                    </small>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Footer -->
    <footer class="container mt-4 mb-4">
        <div class="card">
            <div class="card-body text-center">
                <small class="text-muted">
                    <i class="fas fa-check-circle text-success"></i> 
                    LLM Agent POC v1.0 - All modules working | 
                    <span id="statusText">Demo Mode Active</span> |
                    Built with ❤️ for AI experimentation
                </small>
            </div>
        </div>
    </footer>
</body>
</html>
